<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Application</title>
    <link rel="stylesheet" href="login_style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
</head>

<script type="module">
    // Import the functions you need from the SDKs you need
    import {firebaseConfig} from "./js/config.js";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js'

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional


    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

    // Get a reference to the Firestore service
    const db = getFirestore(app);

    window.getDocs = getDocs;
    window.collection = collection;
    window.db = db;    
    window.addDoc = addDoc;
</script>
<script>
    async function validateLogin() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        try {
            const querySnapshot = await getDocs(collection(db, "admin"));
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                localStorage.setItem("userdata", JSON.stringify(data))
                if (username === data.username && password === data.password) {
                    // Redirect to another page
                    window.location.href = "admin.html";
                } else {
                    // If the username and password don't match, add a new user
                    addUser(username, password);
                    // Redirect to home page
                    // window.location.href = "home.html";
                }
            });
        } catch (e) {
            console.error("Error querying admin collection: ", e);
        }
    }

    async function addUser(username, password) {
        try {
            const docRef = await addDoc(collection(db, "users"), {
                username: username,
                password: password
            });
            console.log("User added with ID: ", docRef.id);
            window.location.href = "home.html";
        } catch (e) {
            console.error("Error adding user: ", e);
            alert("Error occured while logging in!")
        }
    }
</script>

<body>
    <div class="container">
        <div class="card">
            <h2>Login</h2>
            <form onsubmit="event.preventDefault(); validateLogin();">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" required>

                <label for="password">Password</label>
                <input type="password" id="password" name="password" required>
                <br>
                <button type="submit" class="login">Login</button>
            </form>
        </div>
    </div>
</body>

</html>