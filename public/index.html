<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Application</title>
    <link rel="stylesheet" href="login_style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
</head>

<script type="module">
    // Import the functions you need from the SDKs you need
    import { firebaseConfig } from "./js/config.js";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js'

    const app = initializeApp(firebaseConfig);

    // Get a reference to the Firestore service
    const db = getFirestore(app);

    window.getDocs = getDocs;
    window.collection = collection;
    window.db = db;
    window.addDoc = addDoc;
    window.query = query;
    window.where = where;
</script>
<script>

    async function validateLogin() {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const code = document.getElementById('code').value;
        localStorage.setItem("userdata1", JSON.stringify(code));

        try {
            const adminQuerySnapshot = await getDocs(collection(db, "admin"));
            const adminData = adminQuerySnapshot.docs.map(doc => doc.data())[0]; // Assuming there's only one admin

            if (username === adminData.username && password === adminData.password) {
                // Redirect to admin page
                localStorage.setItem("userdata", JSON.stringify(adminData));
                window.location.href = "admin.html";
            } else {
                const questionsQuerySnapshot = await getDocs(query(collection(db, "questions"), where("code", "==", JSON.parse(localStorage.getItem("userdata1")))));

                if (questionsQuerySnapshot.empty) {
                    // Code is incorrect, show error message
                    alert("Incorrect code! Please enter the correct code. There is no quiz for you at the moment");
                } else {
                    // Code is correct, allow login
                    addUser(username, password, code);
                }
            }
        } catch (e) {
            console.error("Error querying collections: ", e);
        }
    }

    // Call the validateLogin function when the form is submitted
    document.querySelector('form').addEventListener('submit', async (event) => {
        event.preventDefault(); // Prevent the default form submission
        await validateLogin();
    });


    async function addUser(username, password, code) {
        try {
            const docRef = await addDoc(collection(db, "users"), {
                username: username,
                password: password,
                code: code
            });
            console.log("User added with ID: ", docRef.id);
            window.location.href = "home.html";
        } catch (e) {
            console.error("Error adding user: ", e);
            alert("Error occured while logging in!")
        }
    }
</script>

<body>
    <div class="container">
        <div class="card">
            <h2>Login</h2>
            <form onsubmit="event.preventDefault(); validateLogin();">
                <label for="username">Username</label>
                <input type="text" id="username" name="username" required>

                <label for="password">Password</label>
                <input type="password" id="password" name="password" required>

                <label for="code">Quiz Code</label>
                <input type="text" id="code" name="code" required>
                <br>
                <button type="submit" class="login">Login</button>
            </form>
        </div>
    </div>
</body>

</html>